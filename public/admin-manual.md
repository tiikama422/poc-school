# 東大式管理塾 管理者マニュアル

## 概要

このマニュアルは、東大式管理塾の管理者向けの操作説明書です。ユーザー管理、承認機能、システム設定について説明します。

## 目次

1. [初期セットアップ](#初期セットアップ)
2. [管理者ダッシュボード](#管理者ダッシュボード)
3. [ユーザー管理](#ユーザー管理)
4. [トラブルシューティング](#トラブルシューティング)
5. [セキュリティ注意事項](#セキュリティ注意事項)

---

## 初期セットアップ

### 1. データベースの設定

Supabaseの管理画面にアクセスし、以下のSQLファイルを順番に実行してください：

1. **ユーザープロファイルテーブルの作成**
   ```sql
   -- sql/user_profiles.sql の内容をコピー&ペースト
   ```

2. **初期管理者の設定**
   ```sql
   -- 管理者のメールアドレスでユーザー登録後、以下を実行
   UPDATE public.user_profiles 
   SET 
     is_approved = true,
     is_admin = true,
     approved_at = timezone('utc'::text, now()),
     approved_by = id
   WHERE email = 'あなたのメールアドレス@example.com';
   ```

### 2. 環境変数の確認

`.env.local`ファイルに以下の設定があることを確認してください：

```env
NEXT_PUBLIC_SUPABASE_URL=your_supabase_url
NEXT_PUBLIC_SUPABASE_ANON_KEY=your_supabase_anon_key
```

---

## 管理者ダッシュボード

### アクセス方法

1. https://your-domain.com/login にアクセス
2. 管理者アカウントでログイン
3. ダッシュボードの「ユーザー管理」ボタンをクリック

### 管理者専用機能

管理者アカウントでログインすると、以下の追加機能が利用できます：

- **ユーザー管理**：`/admin/users` へのアクセス
- **承認機能**：新規ユーザーの承認/承認取消
- **権限管理**：他のユーザーに管理者権限を付与

---

## ユーザー管理

### ユーザー管理画面の使い方

`/admin/users` ページでは、以下の操作が可能です：

#### 1. ユーザー一覧の確認

| 項目 | 説明 |
|------|------|
| ユーザー | ユーザー名（フルネーム）またはメールアドレスの最初の文字 |
| メール | ユーザーのメールアドレス |
| 登録日 | アカウント作成日 |
| 承認状態 | 「承認済み」または「未承認」 |
| 管理者 | 「管理者」または「一般」 |
| 操作 | 承認/管理者権限の変更ボタン |

#### 2. ユーザーの承認

**新規ユーザーを承認する手順：**

1. ユーザー管理画面で「未承認」状態のユーザーを確認
2. 該当ユーザーの「承認」ボタンをクリック
3. 状態が「承認済み」に変更される
4. ユーザーがログイン可能になる

**承認を取り消す手順：**

1. 「承認済み」状態のユーザーの「承認取消」ボタンをクリック
2. 状態が「未承認」に変更される
3. ユーザーのアクセスが無効になる

#### 3. 管理者権限の付与

**管理者権限を付与する手順：**

1. 一般ユーザーの「管理者に」ボタンをクリック
2. 状態が「管理者」に変更される
3. 該当ユーザーが管理機能にアクセス可能になる

**管理者権限を削除する手順：**

1. 管理者ユーザーの「管理者解除」ボタンをクリック
2. 状態が「一般」に変更される
3. 該当ユーザーの管理機能アクセスが無効になる

### 重要な制限

- **自分自身の権限は変更できません**（誤操作防止）
- **承認取消されたユーザーは即座にログアウトされます**
- **管理者権限を削除されたユーザーは管理画面にアクセスできなくなります**

---

## ユーザー登録の流れ

### 新規ユーザーの登録プロセス

1. **ユーザーによる登録**
   - ユーザーがログインページで「Sign Up」をクリック
   - メールアドレスとパスワードを入力
   - 「登録が完了しました。管理者による承認をお待ちください」メッセージが表示

2. **管理者による承認**
   - 管理者がユーザー管理画面で新規ユーザーを確認
   - 「承認」ボタンをクリックして承認
   - ユーザーにログイン可能になったことを連絡

3. **ユーザーのログイン**
   - 承認後、ユーザーが正常にログイン可能
   - 未承認の場合はログインが拒否される

### 承認の判断基準

以下の点を確認してから承認することを推奨します：

- メールアドレスが組織内または信頼できるドメインか
- 事前に登録を申請されているユーザーか
- 不審なアカウント名でないか

---

## トラブルシューティング

### よくある問題と解決方法

#### 1. ユーザーがログインできない

**症状：** 正しいメールアドレスとパスワードでもログインできない

**解決方法：**
1. ユーザー管理画面でユーザーの承認状態を確認
2. 「未承認」の場合は「承認」ボタンをクリック
3. ユーザーに再ログインを依頼

#### 2. 管理画面にアクセスできない

**症状：** ダッシュボードに「ユーザー管理」ボタンが表示されない

**解決方法：**
1. 自分のアカウントの管理者権限を確認
2. Supabaseで以下のSQLを実行：
   ```sql
   SELECT is_admin FROM user_profiles WHERE email = 'あなたのメール';
   ```
3. `false`の場合は管理者権限を付与

#### 3. データベースエラー

**症状：** ユーザー管理画面でエラーが発生する

**解決方法：**
1. Supabaseの管理画面でテーブルが正しく作成されているか確認
2. RLS（Row Level Security）ポリシーが正しく設定されているか確認
3. `sql/user_profiles.sql`を再実行

#### 4. 新規ユーザーが表示されない

**症状：** 登録されたユーザーがユーザー管理画面に表示されない

**解決方法：**
1. ユーザー登録時のトリガーが正しく動作しているか確認
2. Supabaseで以下のクエリを実行：
   ```sql
   SELECT * FROM user_profiles ORDER BY created_at DESC;
   ```
3. データが存在しない場合はトリガーの再設定が必要

---

## セキュリティ注意事項

### 管理者アカウントの管理

#### パスワード管理
- **強力なパスワード**を設定する（英数字記号を含む12文字以上）
- **定期的なパスワード変更**（3-6ヶ月ごと）
- **パスワードマネージャー**の使用を推奨

#### アクセス管理
- **管理者権限の最小化**：必要最小限のユーザーにのみ管理者権限を付与
- **定期的な権限確認**：不要になった管理者権限は速やかに削除
- **ログの監視**：不審なアクセスがないか定期的に確認

### ユーザー承認の基準

#### 承認する場合
- 組織内の既知のユーザー
- 事前に登録申請があったユーザー
- 信頼できるメールドメインからの登録

#### 承認しない場合
- 不明なメールアドレス
- 不審なユーザー名
- 外部からの無断登録

### データ保護

#### 個人情報の取り扱い
- ユーザーのメールアドレスや個人情報を適切に管理
- 必要以上に個人情報を収集しない
- データの第三者提供は禁止

#### バックアップ
- Supabaseの自動バックアップ機能を有効化
- 重要な設定変更前は手動バックアップを実施

---

## 緊急時の対応

### アカウントロックアウト

**全ての管理者がアクセスできなくなった場合：**

1. Supabaseの管理画面に直接アクセス
2. 以下のSQLで管理者権限を復旧：
   ```sql
   UPDATE user_profiles 
   SET is_admin = true, is_approved = true 
   WHERE email = '緊急時用メールアドレス';
   ```

### 不正アクセスの疑い

**対応手順：**

1. **即座に該当ユーザーの承認を取り消し**
2. **パスワードの変更を要求**
3. **ログの確認**（Supabase管理画面）
4. **必要に応じて全ユーザーのパスワードリセット**

---

## 連絡先

システムに関する技術的な問題や緊急事態が発生した場合は、開発チームまでご連絡ください。

**注意：** このマニュアルは定期的に更新されます。最新版を確認して操作を行ってください。

---

*最終更新日: 2025年7月10日*